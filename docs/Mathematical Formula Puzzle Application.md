---
## 数式パズルアプリ：要件定義（Supabase特化版）

このドキュメントは、数式パズルアプリの開発を進める上での要件を定義します。本アプリは、ユーザーが直感的なドラッグ＆ドロップ操作で数式を構築し、それを保存・再利用できるWebアプリケーションを目指します。特に、**Vercelでの公開と費用最小化**を念頭に置き、バックエンドとして**Supabase**を活用します。
---

### 1. アプリケーションの目的

高校数学の範囲内で、ユーザーが視覚的かつ直感的な「パズル」形式で数式を組み立て、その数式を高品質な形式で表示・出力・保存することで、数式入力のハードルを下げ、学習効率の向上を支援する。**空のブロックを活用して小さな数式を組み上げ、それらをさらに組み合わせて複雑な数式を構築できる**ようにすることで、複雑な数式作成のプロセスを段階的に進められるようにする。

---

### 2. ユーザー（利用者）

-   高校生、大学生（数学初学者）
-   数学教師、講師
-   数式の視覚的入力・編集を求める研究者やビジネスパーソン

---

### 3. 主要機能要件

本アプリが提供するべき主要な機能は以下の通りです。

#### 3.1. 数式入力・編集機能

-   **ピースの提供**:
    -   数字（0-9）、小数点（.）、変数（x, y, z など）、基本的な演算子（+, -, ×, ÷）。
    -   括弧（()）、等号（=）、不等号（<, >, ≤, ≥）。
    -   基本的な関数（sin, cos, tan, log, ln, exp）。
    -   特殊記号（π, e, i（虚数単位））。
    -   構造化記号（分数、平方根、n 乗根、上付き文字、下付き文字）。
    -   集合・論理記号（∈, ∉, ⊂, ⊃, ∧, ∨ など）。
    -   総和（$\Sigma$）、積分（$\int$）、微分（$\frac{d}{dx}$）などの高校数学範囲の記号。
    -   **空のブロック（Group Block）**: 内部に他の数式ピースや別の空のブロックを配置できる、汎用的な入れ子可能なコンテナピース。
-   **パレットからのピース生成**:
    -   画面の**左サイドバー**に配置された**ハイブリッド階層構造のパレット**から、数式ピースの種類を選択できる。
    -   パレットは主要カテゴリーをタブ切り替え、サブカテゴリーは展開/折りたたみ可能である。
    -   ピースクリックによって、選択されたピースが**キャンバス（入力領域）**に左から右へ順次配置され、キャンバスの幅を超えた場合は折り返して表示される。
    -   パレットの各ピースにはホバー時のプレビュー機能を提供する。
    -   **分数の自動生成**: 上下に配置されたピースは自動的に分数として結合される（初心者向け基本機能）。
-   **左右配置要素**: 二項係数（nCr 形式）、関数、括弧などは左右の白い角丸ピースで構成される。
-   **直感的操作の設定**: 累乗、平方根、括弧、関数などの自動結合はユーザー設定で有効/無効を選択可能。
-   **ドラッグ＆ドロップによる数式構築**:
    -   キャンバス上に現れたピースは、**2 次元空間で自由にドラッグ＆ドロップして移動・配置できる**。
    -   ピース同士は、論理的に結合可能な箇所（例：演算子の両側、関数の引数部分、空のブロック内部）にドロップされた場合にのみ、結合できる。
    -   **空のブロックの活用**:
        -   ユーザーはまず空のブロックをキャンバスに配置できる。
        -   その空のブロックの内部に、他の数式ピースやさらに別の空のブロックをドラッグ＆ドロップして配置し、**小さな数式（部分式）を組み立てる**ことができる。
        -   完成した小さな数式を含む空のブロック自体を、あたかも単一のピースのようにドラッグし、より大きな数式や別の空のブロックに組み込むことができる。これにより、**段階的に複雑な数式を構築**できる。
    -   無効な結合を試みた場合は、視覚的（例：ドロップ先のハイライト解除）および聴覚的フィードバックでユーザーに通知する。
-   **数式のリアルタイム表示**:
    -   ユーザーがピースを配置・編集するたびに、入力領域上部または隣接するプレビューエリアに、高品質な数式（LaTeX 形式でレンダリング）がリアルタイムで表示される。表示されるのは、**キャンバス上で最終的に結合された（意味を持つ）数式全体**とする。
-   **編集操作**:
    -   配置したピースの選択、削除、コピー＆ペースト。
    -   複数のピースやブロックを選択し、グループとして移動・コピー・削除できる機能。
    -   アンドゥ（元に戻す）/リドゥ（やり直し）機能。

#### 3.2. 保存・再利用機能

-   **ユーザー認証**:
    -   **Supabase Authentication** を利用した新規ユーザー登録（メールアドレス/パスワード、ソーシャルログイン（Google, GitHub など））。
    -   Supabase Authentication を利用した既存ユーザーのログイン/ログアウト。
-   **数式の保存**:
    -   作成した数式にタイトルを付けて、ユーザーアカウントに紐付けて**Supabase データベース（PostgreSQL）**に保存できる。
    -   数式の最終的な LaTeX 文字列と、パズル形式で復元するための AST（抽象構文木）データを JSON 形式で保存する。**AST には、各ピースのキャンバス上での 2 次元座標情報も含む**こと。
-   **保存済み数式の一覧表示**:
    -   ユーザーが保存した数式を一覧で表示し、タイトル、作成/更新日時などで並べ替えや検索ができる。
-   **保存済み数式の読み込み**:
    -   一覧から数式を選択し、パズル形式の入力領域に完全に復元して再編集できる。この際、**保存時のピースの配置（2 次元座標）を可能な限り再現する**。
-   **数式の更新/削除**:
    -   保存済みの数式の内容やタイトルを更新できる。
    -   保存済みの数式を削除できる。

#### 3.3. 出力・共有機能

-   **LaTeX 文字列のコピー**:
    -   作成・表示されている数式の LaTeX 文字列をクリップボードにコピーできるボタン。
-   **画像形式でのエクスポート (オプション)**:
    -   作成した数式を PNG や SVG などの画像形式でエクスポートできる機能。**クライアントサイドでの画像生成**を優先し、サーバーリソースの消費を避ける。

---

### 4. 非機能要件

アプリの品質とユーザー体験に関する要件です。

-   **パフォーマンス**:
    -   数式ピースのドラッグ＆ドロップ操作、リアルタイム表示はスムーズで、遅延なく行われること。
    -   複雑な数式や多数のピースが存在する場合でも、レンダリングや操作に大きな遅延がないこと。
    -   Supabase への保存・読み込み処理は迅速であること。
-   **可用性**:
    -   Supabase サービスは安定稼働し、高い稼働率を維持すること。
    -   データは Supabase によって適切に管理・バックアップされること。
-   **スケーラビリティ**:
    -   Supabase の無料枠（Free Plan）内で、個人開発および小規模な利用であれば問題なく運用できること。
    -   将来的なユーザー数増加や保存される数式の増加に対応できるよう、Supabase の有料プランへの移行も視野に入れたアーキテクチャであること。
-   **セキュリティ**:
    -   Supabase Authentication および **Row Level Security (RLS)** を適切に設定し、ユーザー認証情報や保存データが安全に保護されること。
    -   ユーザーが自分の数式のみを操作できるように、データベースレベルでのアクセス制御を厳密に行うこと。
    -   API 通信は HTTPS で行われること。
-   **ユーザビリティ**:
    -   直感的で分かりやすい UI/UX デザイン。特に、**パズルピースの結合点やドロップエリアの視覚的フィードバック**は明確であること。
    -   エラーメッセージは明確で、解決策を提示できること。
    -   初心者でも簡単に操作できるようなチュートリアルやヘルプ機能。
-   **アクセシビリティ**:
    -   主要な Web アクセシビリティ標準（WCAG）に準拠し、様々なユーザーが利用できること。
-   **互換性**:
    -   主要な Web ブラウザ（Chrome, Firefox, Safari, Edge）の最新バージョンで正しく動作すること。
    -   PC、タブレット、スマートフォンの各デバイスで、レスポンシブデザインにより適切に表示・操作できること。

---

### 5. 技術スタック

-   **フロントエンド**: React, Tailwind CSS
-   **数式レンダリング**: MathJax または KaTeX
-   **ドラッグ＆ドロップ**: React DnD, dnd-kit など (2 次元空間での自由移動と結合に対応できるもの)
-   **バックエンド/データベース/認証**: **Supabase** (PostgreSQL, Authentication, Realtime, Functions)
-   **デプロイメント**: **Vercel** (フロントエンドのホスティング)

---

### 6. 今後の展望（オプション機能）

-   **共同編集機能**: 複数ユーザーで同時に数式を編集できる機能。
-   **バージョン管理**: 数式の編集履歴を保存し、任意の時点に戻せる機能。
-   **グラフ描画機能**: 構築した関数や式を元にグラフを描画する機能。
-   **計算機能**: 構築した式を元に計算を実行し、結果を表示する機能。
-   **画像認識**: 手書きや画像からの数式認識・変換機能。
-   **テンプレート機能**: よく使う数式のテンプレートを提供し、そこから編集を開始できる機能。

---
