---
# 数式パズルアプリ：開発手順書（Vercel + Supabase版）

このドキュメントは、数式パズルアプリの開発を進める上での具体的な手順とガイドラインを定義します。[PaperFree.com](https://paperfree.com/en/magazine/7-steps-on-how-to-develop-a-protocol-or-procedures-manual)と[PowerDMS](https://www.powerdms.com/why-powerdms/6-guidelines-for-procedure-development)の手順書作成ガイドラインに基づいて作成されています。**Vercelでの公開とSupabaseデータベースの使用**を前提とした構成となっています。
---

## 1. 開発準備フェーズ

### 1.1. プロジェクト環境のセットアップ

-   **開発環境の構築**:

    -   Node.js、npm/yarn のインストール
    -   Vite + React + TypeScript 開発環境のセットアップ
    -   エディタ（VS Code 推奨）の設定
    -   Git リポジトリの初期化

-   **技術スタックの確定**:
    -   フロントエンド: React 18.x、TypeScript
    -   ビルドツール: Vite
    -   スタイリング: Tailwind CSS
    -   数式レンダリング: KaTeX
    -   ドラッグ＆ドロップ: dnd-kit
    -   バックエンド: Supabase（PostgreSQL、Authentication、Realtime、Functions）
    -   デプロイメント: Vercel
    -   認証: Supabase Authentication

### 1.2. プロジェクト構造の設計

```
mathematical-formula-puzzle-app/
├── src/
│   ├── components/
│   │   ├── FormulaPieces/
│   │   │   ├── BasicSymbols/
│   │   │   ├── Functions/
│   │   │   ├── Structures/
│   │   │   └── Calculus/
│   │   ├── Canvas/
│   │   ├── Palette/
│   │   └── Preview/
│   ├── hooks/
│   │   ├── useSupabase.ts
│   │   ├── useAuth.ts
│   │   └── useFormula.ts
│   ├── services/
│   │   ├── supabase.ts
│   │   ├── auth.ts
│   │   └── formulas.ts
│   ├── types/
│   │   ├── formula.ts
│   │   ├── user.ts
│   │   └── supabase.ts
│   └── utils/
├── supabase/
│   ├── migrations/
│   ├── functions/
│   └── seed.sql
├── public/
├── vercel.json
├── vite.config.ts
└── package.json
```

---

## 2. 要件分析と設計フェーズ

### 2.1. 詳細要件の定義

#### 2.1.1. 数式ピースの詳細仕様

**基本記号カテゴリ（青色系）**:

-   **数字・小数点**: 0-9、小数点（.）
-   **定数・変数**: ラテン文字（a-z, A-Z）、ギリシャ文字（α, β, γ 等）
-   **括弧・等号・不等号**: (, ), =, ≠, <, >, ≤, ≥
-   **集合・論理記号**: ∈, ∉, ∩, ∪, ∀, ∃, ∧, ∨

**基本関数・構造記号カテゴリ（緑色系）**:

-   **平方根**: √ 記号 + 被開平数（白い角丸）
-   **n 乗根**: 指数（白い角丸）+ √ 記号 + 被開平数（白い角丸）
-   **累乗**: 底（白い角丸）+ 指数（白い角丸、横並び配置）
-   **三角関数**: sin, cos, tan + 引数（白い角丸）
-   **二項係数**: 全数（白い角丸）+ C 記号 + 選択数（白い角丸）
-   **順列**: 全数（白い角丸）+ P 記号 + 選択数（白い角丸）
-   **分数**: 上下配置による自動生成（専用ピース不要）

**視覚的表現**: 複数の角丸や記号が並ぶ要素（n 乗根、累乗、二項係数、順列など）は、緑色系のベース色の角丸の中に配置

**微積分・総和カテゴリ（紫色系）**:

-   **総和記号**: Σ 記号 + インデックス、開始値、終了値、一般項（各白い角丸）
-   **総積記号**: Π 記号 + インデックス、開始値、終了値、一般項（各白い角丸）
-   **積分記号**: ∫ 記号 + 下限、上限、関数、d、積分変数（各白い角丸）

**視覚的表現**: 複数の角丸や記号が並ぶ要素（総和記号、総積記号、積分記号など）は、紫色系のベース色の角丸の中に配置

**空ブロック（グレー系）**:

-   カスタマイズ可能な白い角丸ブロック

#### 2.1.2. ドラッグ＆ドロップの結合ルール

-   **接続可能な位置の定義**:

    -   **白い角丸（プレースホルダー）への数式挿入**: 空のブロック内で数式を作成してから、その数式全体を白い角丸に挿入（再帰的な挿入が可能）
    -   **同色の角丸同士の結合**: 累乗構造など、ピースの仕様で事前に確定された結合
    -   **構造記号とその引数の結合**: ピースの仕様で事前に確定された結合

-   **結合ルール**:
    -   数学的に有効な結合のみ許可
    -   型チェックによる結合可能性の検証
    -   視覚的フィードバック（結合可能位置のハイライト）
    -   カテゴリー別色分けによる直感的な操作支援
    -   **分数の自動生成**: 上下に配置されたピースは自動的に分数として結合（初心者向け基本機能）
    -   **左右配置要素**: 二項係数（nCr 形式）、順列（nPr 形式）、関数、括弧などは左右の白い角丸ピースで構成
    -   **直感的操作の設定**: 累乗、平方根、括弧、関数などの自動結合はユーザー設定で有効/無効を選択可能
    -   **再帰的挿入**: 白い角丸内で作成された数式は、さらに別の白い角丸に挿入可能（ネストした構造の構築）

#### 2.1.3. 空のブロックの動作仕様

-   **カスタマイズ機能**:

    -   任意の数式・記号の入力
    -   LaTeX 形式での直接入力
    -   既存ピースからのコピー

-   **保存・読み込み機能の詳細**:
    -   数式構造の AST（抽象構文木）形式での保存
    -   LaTeX 形式でのエクスポート
    -   画像形式でのエクスポート（PNG, SVG）

#### 2.1.4. パレット UI 仕様

-   **配置**: 左サイドバー固定配置
-   **ハイブリッド階層構造**:

    -   主要カテゴリー: タブ切り替え（基本記号、関数・構造、微積分・総和、空ブロック）
    -   サブカテゴリー: 展開/折りたたみ機能
    -   各カテゴリーは色分けで識別
    -   ピースのプレビュー表示（ホバー時）

-   **レスポンシブ対応**:

    -   デスクトップ: 左サイドバー固定表示
    -   タブレット: 左サイドバー（幅調整）
    -   モバイル: 上部に折りたたみ、必要時に展開

-   **インタラクション**:
    -   ピースクリックでキャンバスに左から右へ順次配置（幅を超えた場合は折り返し）
    -   タブ切り替えによる主要カテゴリー選択
    -   サブカテゴリーの展開/折りたたみ
    -   ピース検索機能（各カテゴリー内）

#### 2.1.5. ユーザー設定機能

-   **直感的操作の設定**:

    -   分数の自動生成: 常に有効（初心者向け基本機能）
    -   累乗の自動生成: ユーザー設定で有効/無効選択可能
    -   平方根の自動生成: ユーザー設定で有効/無効選択可能
    -   括弧の自動展開: ユーザー設定で有効/無効選択可能
    -   関数の自動適用: ユーザー設定で有効/無効選択可能
    -   総和・積分の自動構築: ユーザー設定で有効/無効選択可能
    -   等号・不等号の自動結合: ユーザー設定で有効/無効選択可能
    -   集合記号の自動適用: ユーザー設定で有効/無効選択可能

-   **設定の保存・復元**:
    -   ユーザー設定は Supabase データベースに保存
    -   ログイン時に自動復元
    -   設定変更はリアルタイムで反映

### 2.2. 非機能要件の定量化

-   レスポンス時間: ドラッグ操作 < 100ms
-   同時接続数: 100 ユーザー
-   データ保存容量: ユーザーあたり最大 100MB
-   数式レンダリング精度: 99.9%
-   ブラウザ互換性: Chrome, Firefox, Safari, Edge 最新版

### 2.3. システム設計

-   **アーキテクチャ設計**:

    -   フロントエンド: SPA（Single Page Application）
    -   バックエンド: Supabase（サーバーレス）
    -   データベース: PostgreSQL（Supabase）

-   **データモデル設計**:
    -   ユーザー情報（Supabase Auth）
    -   数式データ（LaTeX + AST）
    -   ピース配置情報
    -   数式ピースの型定義

### 2.4. Supabase データベース設計

#### 2.4.1. テーブル設計

```sql
-- 数式テーブル
CREATE TABLE formulas (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  latex_content TEXT NOT NULL,
  ast_data JSONB NOT NULL,
  canvas_data JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ユーザープロファイルテーブル
CREATE TABLE user_profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  username TEXT UNIQUE,
  display_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ユーザー設定テーブル
CREATE TABLE user_settings (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  auto_power BOOLEAN DEFAULT FALSE,
  auto_sqrt BOOLEAN DEFAULT FALSE,
  auto_brackets BOOLEAN DEFAULT FALSE,
  auto_functions BOOLEAN DEFAULT FALSE,
  auto_summation BOOLEAN DEFAULT FALSE,
  auto_equality BOOLEAN DEFAULT FALSE,
  auto_sets BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2.4.2. Row Level Security (RLS) 設定

```sql
-- 数式テーブルのRLS
ALTER TABLE formulas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own formulas" ON formulas
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own formulas" ON formulas
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own formulas" ON formulas
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own formulas" ON formulas
  FOR DELETE USING (auth.uid() = user_id);

-- ユーザー設定テーブルのRLS
ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own settings" ON user_settings
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own settings" ON user_settings
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own settings" ON user_settings
  FOR INSERT WITH CHECK (auth.uid() = id);
```

---

## 3. プロトタイプ開発フェーズ

### 3.1. 基本機能のプロトタイプ作成

-   **最小限の機能実装**:

    -   基本的な数式ピースの表示（カテゴリー別色分け、白い角丸）
    -   左サイドバーパレットの基本レイアウト（ハイブリッド階層構造）
    -   シンプルなドラッグ＆ドロップ
    -   基本的な LaTeX レンダリング
    -   空ブロックへの記号挿入機能
    -   **分数の自動生成機能**: 上下配置による分数自動結合の基本実装（初心者向け基本機能）

-   **左右配置要素**: 二項係数（nCr 形式）、関数、括弧の左右角丸ピース基本実装
-   **直感的操作設定機能**: 累乗、平方根、括弧、関数の自動結合設定 UI

    -   Supabase 認証の基本実装

-   **テスト環境の構築**:
    -   単体テスト環境（Jest）
    -   E2E テスト環境（Cypress）
    -   パフォーマンステスト環境

### 3.2. プロトタイプのテスト

-   **内部テスト**:

    -   開発チームによる機能テスト
    -   パフォーマンステスト
    -   セキュリティテスト

-   **ユーザビリティテスト**:
    -   5-10 名の対象ユーザーによるテスト
    -   フィードバックの収集と分析

---

## 4. 本格開発フェーズ

### 4.1. フロントエンド開発

-   **コンポーネント開発**:

    -   数式ピースコンポーネント（各カテゴリ別、色分け対応）
    -   キャンバスコンポーネント（2 次元配置対応）
    -   パレットコンポーネント（左サイドバー、ハイブリッド階層構造、タブ切り替え、カテゴリ別色分け表示）
    -   プレビューコンポーネント（リアルタイムレンダリング）

-   **機能実装**:
    -   ドラッグ＆ドロップ機能（2 次元空間対応）
    -   リアルタイムレンダリング
    -   編集操作（アンドゥ/リドゥ）
    -   保存・読み込み機能
    -   空ブロックのカスタマイズ機能
    -   パレットのハイブリッド階層構造（タブ切り替え + 展開/折りたたみ）機能
    -   **分数の自動生成機能**: 上下配置による分数自動結合（初心者向け基本機能）
-   **左右配置要素の処理**: 二項係数（nCr 形式）、関数、括弧の左右角丸ピース対応
-   **直感的操作設定機能**: 累乗、平方根、括弧、関数の自動結合設定

### 4.2. Supabase 統合開発

-   **認証機能の実装**:

    -   Supabase Authentication の設定
    -   ログイン・ログアウト機能
    -   ユーザー登録機能
    -   ソーシャルログイン（Google, GitHub）

-   **データベース機能の実装**:
    -   数式の保存・取得機能
    -   リアルタイム同期機能
    -   データ検証機能
    -   数式変換機能（AST ↔ LaTeX）
    -   カテゴリー別色分け設定の保存・復元機能
    -   パレット設定（タブ状態、展開状態）の保存・復元機能

### 4.3. 統合開発

-   **フロントエンド・Supabase 統合**:
    -   Supabase Client の設定
    -   エラーハンドリング
    -   セキュリティ対策
    -   オフライン対応

---

## 5. テスト・品質保証フェーズ

### 5.1. 包括的テスト

-   **単体テスト**:

    -   各コンポーネントのテスト
    -   Supabase 関数のテスト
    -   カバレッジ 80%以上を目標

-   **統合テスト**:

    -   フロントエンド・Supabase 連携テスト
    -   データベース操作テスト

-   **E2E テスト**:
    -   ユーザー操作フローのテスト
    -   ブラウザ互換性テスト

### 5.2. パフォーマンステスト

-   **負荷テスト**:

    -   同時接続テスト
    -   大量データ処理テスト

-   **最適化**:
    -   レンダリング性能の最適化
    -   Supabase クエリの最適化

---

## 6. デプロイ・運用フェーズ

### 6.1. Vercel 本番環境構築

-   **Vercel 設定**:

    -   Vercel プロジェクトの作成
    -   環境変数の設定
    -   カスタムドメインの設定（オプション）
    -   CI/CD パイプラインの構築

-   **Supabase 本番環境設定**:
    -   本番 Supabase プロジェクトの作成
    -   データベースマイグレーションの実行
    -   RLS ポリシーの設定
    -   バックアップ設定

### 6.2. 段階的リリース

-   **ベータ版リリース**:

    -   限定ユーザーによるベータテスト
    -   フィードバックの収集と改善

-   **正式版リリース**:
    -   一般公開
    -   マーケティング活動の開始

---

## 7. 保守・改善フェーズ

### 7.1. 継続的改善

-   **ユーザーフィードバックの収集**:

    -   アンケート機能の実装
    -   使用状況の分析

-   **機能改善**:
    -   新機能の追加
    -   既存機能の改善

### 7.2. 運用保守

-   **定期メンテナンス**:
    -   セキュリティアップデート
    -   パフォーマンス監視
    -   バックアップ確認

---

## 8. 開発スケジュール

| フェーズ         | 期間        | 主要成果物                   |
| ---------------- | ----------- | ---------------------------- |
| 準備フェーズ     | 2 週間      | 開発環境、プロジェクト構造   |
| 要件分析・設計   | 4 週間      | 詳細設計書、プロトタイプ     |
| プロトタイプ開発 | 5 週間      | 基本機能プロトタイプ         |
| 本格開発         | 10 週間     | 完全なアプリケーション       |
| テスト・品質保証 | 4 週間      | テスト結果、品質報告         |
| デプロイ・運用   | 2 週間      | 本番環境、運用体制           |
| **合計**         | **27 週間** | **完成したアプリケーション** |

---

## 9. リスク管理

### 9.1. 技術的リスク

-   **ドラッグ＆ドロップの複雑性**:

    -   リスク: 2 次元空間での結合ロジックが複雑
    -   対策: 段階的な実装、十分なテスト

-   **パフォーマンス問題**:

    -   リスク: 複雑な数式での遅延
    -   対策: Vite の高速ビルド機能、最適化、仮想化技術の活用

-   **数式レンダリングの精度**:

    -   リスク: 複雑な数式の表示エラー
    -   対策: KaTeX の最適化、フォールバック機能

-   **Supabase 制限**:
    -   リスク: 無料枠の制限に達する
    -   対策: 使用量監視、有料プランへの移行準備

### 9.2. プロジェクトリスク

-   **スケジュール遅延**:

    -   リスク: 予想以上の開発時間
    -   対策: バッファ時間の確保、優先度の調整

-   **要件変更**:
    -   リスク: 開発中の要件変更
    -   対策: アジャイル開発手法の採用

---

## 10. 成功指標

### 10.1. 技術指標

-   ページ読み込み時間 < 3 秒
-   ドラッグ操作のレスポンス時間 < 100ms
-   テストカバレッジ > 80%
-   バグ発生率 < 1%
-   数式レンダリング精度 > 99.9%

### 10.2. ビジネス指標

-   ユーザー登録数（目標: 1000 人/月）
-   アクティブユーザー数（目標: 500 人/月）
-   数式保存数（目標: 5000 個/月）
-   ユーザー満足度（目標: 4.5/5.0）

---

## 11. Vercel + Supabase 特有の考慮事項

### 11.1. コスト最適化

-   **Vercel 無料枠の活用**:

    -   月間 100GB の帯域幅
    -   サーバーレス関数の実行時間制限
    -   自動スケーリングの活用

-   **Supabase 無料枠の活用**:
    -   月間 500MB のデータベース容量
    -   月間 50,000 の行読み取り
    -   月間 50,000 の行書き込み

### 11.2. パフォーマンス最適化

-   **Vite の高速ビルド機能**の活用
-   **Vercel Edge Functions**の活用
-   **Supabase Realtime**の効率的な使用
-   **CDN**の活用（Vercel 自動提供）

### 11.3. セキュリティ

-   **Supabase RLS**の適切な設定
-   **環境変数**の安全な管理
-   **CORS**設定の最適化

---

この開発手順書は、プロジェクトの進行に伴い、必要に応じて更新・調整を行います。各フェーズの完了時には、成果物の確認と次のフェーズへの移行判断を行います。
